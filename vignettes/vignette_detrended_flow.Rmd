---
title: "Vignette, Detrended Flow"
author: "Erik.Leppo@tetratech.com"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---
<!-- Data is in vignettes\data folder  -->
```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```
# Purpose
Creation of a seasonally-detrended flow data set with visualizations (plots).

# Example Code
Will show the code in chunks below with comments.

## Project Folder and Load Functions
Set the working directory and load any needed scripts and libraries.

```{r projRoot, eval=FALSE}
ProjRoot <- getwd()
#setwd(ProjRoot)

library(baytrends)

require(gdata)

source(file.path(ProjRoot, "data", "getUSGSflow.R"))
source(file.path(ProjRoot, "data", "seasAdjflow2.R"))
source(file.path(ProjRoot, "data", "supportFunctions.R"))

# source("R/getUSGSflow.R")
# source("R/seasAdjflow2.R")
# source("R/smwrBaseFunctions.R")
# source("R/supportFunctions.R")
chkPackages()

knitr::opts_chunk$set(dpi=150)
```

## Load Station, Parameters, and Layer Lookup Lists
Set station list and other parameters.

```{r gageList, results='asis', eval=FALSE}

#gageList <- baytrends::usgsGages
gageList <- data.frame(usgsGageID=c("01491000", "01578310"),
                       siteName=c("Choptank River near Greensboro, MD",
                                  "Susquehanna River at Conowingo, MD"),
                       stringsAsFactors = FALSE)

# set up flow retrieval and seasonal adjustment parameters
flow.detrended <- list(retreiveDate  = Sys.time(),
                       gages         = gageList,
                       yearStart     = 1983,
                       yearEnd       = 2016,
                       dvAvgWinSel   = c(1, 5, 10, 15, 20, 30, 40, 50, 
                                         60, 90, 120, 150, 180, 210),
                       dvAvgWgtSel   = "uniform",
                       dvAvgSidesSel = 1,
                       lowess.f      = 0.2)

outputFileName <- file.path(ProjRoot, "data"
                            , paste0(flow.detrended$yearStart, "-"
                                     , flow.detrended$yearEnd
                                     , " seasonally detrended flow data.rda"))
selectPlots <- flow.detrended$dvAvgWinSel[c(1,2,length(flow.detrended$dvAvgWinSel))]


```

## Retrieve Flow and Detrend
Get the data and detrend it.

An RDA file will be created in the vignette data folder.  The file name will have the start and end dates as a prefix to "seasonally detrended flow data.rda".
```{r retFlow, results='asis', echo=TRUE, warnings=FALSE, eval=FALSE}

figNum <<- 0 

# perform analysis for each gage
for (i.gage in 1:length(flow.detrended$gages$usgsGageID)) {

  .H2(paste0(flow.detrended$gages$usgsGageID[i.gage],"-",
             flow.detrended$gages$siteName[i.gage]))
  # set up variable names for raw and summary data
  var       <- paste0("q",flow.detrended$gages$usgsGageID[i.gage])
  var.sum   <- paste0("q",flow.detrended$gages$usgsGageID[i.gage],".sum") 
  
  # download flow data (relies on get the dataRetrieval::readNWISdv) 
  # siteNumber = flow.detrended$gages$usgsGageID[i.gage];  yearStart  = flow.detrended$yearStart
  # yearEnd    = flow.detrended$yearEnd; span       = 10; max.fill   = 10; fill       = TRUE
  df.flow <- getUSGSflow(siteNumber = flow.detrended$gages$usgsGageID[i.gage], 
                         yearStart  = flow.detrended$yearStart, 
                         yearEnd    = flow.detrended$yearEnd, 
                         span       = 10, 
                         max.fill   = 10,
                         fill       = TRUE)
  
  # compute seasonally adjusted (i.e., detrended) flows and compute seasonal averages
  df.flow <- seasAdjflow(dvFlow     = df.flow,
                         siteNumber = flow.detrended$gages$usgsGageID[i.gage],
                         dvAvgWin   = flow.detrended$dvAvgWinSel,
                         dvAvgWgt   = flow.detrended$dvAvgWgtSel, 
                         dvAvgSides = flow.detrended$dvAvgSidesSel,
                         plotResid  = selectPlots)
  
  # put seasonal averages into a list
  # set embedded df to correspond to GageID
  # append list to overall list 
  tmp.list        <- list(df.flow[,c(1,5,9:length(df.flow))]) 
  names(tmp.list) <- var
  flow.detrended  <- modifyList(flow.detrended, tmp.list)
  
  # calculate mean, sd, & nobs by doy
  df      <- flow.detrended[[var]];   
  df      <- df[,!(names(df) %in% c("date", "q", "LogQ", paste0(var,".gam") ))]
  df.mean <- aggregate(. ~ doy, FUN = mean,        data = df, na.action=na.pass, na.rm=TRUE) 
  df.sd   <- aggregate(. ~ doy, FUN = sd,          data = df, na.action=na.pass, na.rm=TRUE) 
  df.nobs <- aggregate(. ~ doy, FUN = gdata::nobs, data = df, na.action=na.pass, na.rm=TRUE) 
  
  # compute lowess smooth standard deviation (sd)
  if(exists("df.lowess")) rm("df.lowess")
  df.sd.filled <- df.sd
  for (i.day in flow.detrended$dvAvgWinSel) {
    var2  <- paste0("d",i.day)
    # fill in missing sd
    df.sd.filled[, var2] <- fillMissing(df.sd.filled[, var2] )
    # smooth sd
    df2 <- as.data.frame(lowess(x=df.sd.filled[,"doy"], 
                                y=df.sd.filled[, var2] , 
                                f= flow.detrended$lowess.f))
    names(df2) <- c("doy",var2)
    # append i.day'th result
    if(!exists("df.lowess")) {
      df.lowess <- df2 
    } else {
      df.lowess <- merge(df.lowess,df2, by='doy')
    }
  }        
  
  # put mean, sd, nobs, & lowess by doy into a list; 
  # set embedded df to correspond to GageID.sum
  # append list to overall list
  tmp.list        <- list(list(mean = df.mean, sd = df.sd, nobs = df.nobs, lowess.sd = df.lowess))
  names(tmp.list) <- var.sum
  flow.detrended  <- modifyList(flow.detrended, tmp.list)
  
}  

save(flow.detrended, file=outputFileName)

```

## Flow Statistics
Flow statistics and output will be created from the new data file.
```{r flowStat, results='asis', echo=TRUE, warnings=FALSE, fig.height=7, fig.width=6.5, eval=FALSE}

for (i.gage in 1:length(flow.detrended$gages$usgsGageID)) {
  
  # set up variable names for raw and summary data
  gage       <- paste0("q",flow.detrended$gages$usgsGageID[i.gage])
  gage.sum   <- paste0("q",flow.detrended$gages$usgsGageID[i.gage],".sum") 
  
  for (dvAvgWinSel in paste0("d",selectPlots) ) {
    .H2(paste0(flow.detrended$gages$usgsGageID[i.gage],"-",
               flow.detrended$gages$siteName[i.gage],
               "  (Avg. Per.: ",dvAvgWinSel,")"))    
    gage.mean      <- flow.detrended[[gage.sum]][["mean"]][[dvAvgWinSel]]
    gage.sd        <- flow.detrended[[gage.sum]][["sd"]][[dvAvgWinSel]]
    gage.doy       <- flow.detrended[[gage.sum]][["sd"]][["doy"]]
    gage.lowess.sd <- flow.detrended[[gage.sum]][["lowess.sd"]][[dvAvgWinSel]]
    gage.nobs      <- flow.detrended[[gage.sum]][["nobs"]][[dvAvgWinSel]]

    par(mfrow = c(3, 1))
    {
      plot(gage.doy, gage.mean , ylim=c(-0.4,0.4)); title(gage)
      plot(gage.doy, gage.sd , ylim=c(0,2), col='grey'); title(gage)
      lines(gage.doy, gage.lowess.sd, col='red',lwd=2)
      plot(gage.doy, gage.nobs , ylim=c(0,60)); title(gage)
            figNum <<- figNum + 1
      title <- paste0( dvAvgWinSel, ": Mean, standard deviation, and number of observations ",
                       " as a Function of Day of Year.")
      .F(title, figNum)
    }
  }
}

```

# Results
Run the above code chunks all at once and show the output below.

```{r ALL, results='asis', echo=FALSE, warnings=FALSE, fig.height=7, fig.width=6.5, message=FALSE}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
ProjRoot <- getwd()
setwd(ProjRoot)

library(baytrends)

require(gdata)

source(file.path(ProjRoot, "data", "getUSGSflow.R"))
source(file.path(ProjRoot, "data", "seasAdjflow2.R"))
source(file.path(ProjRoot, "data", "supportFunctions.R"))

# source("R/getUSGSflow.R")
# source("R/seasAdjflow2.R")
# source("R/smwrBaseFunctions.R")
# source("R/supportFunctions.R")
chkPackages()

knitr::opts_chunk$set(dpi=150)
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#gageList <- baytrends::usgsGages
gageList <- data.frame(usgsGageID=c("01491000", "01578310"),
                       siteName=c("Choptank River near Greensboro, MD",
                                  "Susquehanna River at Conowingo, MD"),
                       stringsAsFactors = FALSE)

# set up flow retrieval and seasonal adjustment parameters
flow.detrended <- list(retreiveDate  = Sys.time(),
                       gages         = gageList,
                       yearStart     = 1983,
                       yearEnd       = 2016,
                       dvAvgWinSel   = c(1, 5, 10, 15, 20, 30, 40, 50, 
                                         60, 90, 120, 150, 180, 210),
                       dvAvgWgtSel   = "uniform",
                       dvAvgSidesSel = 1,
                       lowess.f      = 0.2)

outputFileName <- file.path(ProjRoot, "data"
                            , paste0(flow.detrended$yearStart, "-"
                                     , flow.detrended$yearEnd
                                     , " seasonally detrended flow data.rda"))
selectPlots <- flow.detrended$dvAvgWinSel[c(1,2,length(flow.detrended$dvAvgWinSel))]

#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# retFlow
figNum <<- 0 

# perform analysis for each gage
for (i.gage in 1:length(flow.detrended$gages$usgsGageID)) {

  .H2(paste0(flow.detrended$gages$usgsGageID[i.gage],"-",
             flow.detrended$gages$siteName[i.gage]))
  # set up variable names for raw and summary data
  var       <- paste0("q",flow.detrended$gages$usgsGageID[i.gage])
  var.sum   <- paste0("q",flow.detrended$gages$usgsGageID[i.gage],".sum") 
  
  # download flow data (relies on get the dataRetrieval::readNWISdv) 
  # siteNumber = flow.detrended$gages$usgsGageID[i.gage];  yearStart  = flow.detrended$yearStart
  # yearEnd    = flow.detrended$yearEnd; span       = 10; max.fill   = 10; fill       = TRUE
  df.flow <- getUSGSflow(siteNumber = flow.detrended$gages$usgsGageID[i.gage], 
                         yearStart  = flow.detrended$yearStart, 
                         yearEnd    = flow.detrended$yearEnd, 
                         span       = 10, 
                         max.fill   = 10,
                         fill       = TRUE)
  
  # compute seasonally adjusted (i.e., detrended) flows and compute seasonal averages
  df.flow <- seasAdjflow(dvFlow     = df.flow,
                         siteNumber = flow.detrended$gages$usgsGageID[i.gage],
                         dvAvgWin   = flow.detrended$dvAvgWinSel,
                         dvAvgWgt   = flow.detrended$dvAvgWgtSel, 
                         dvAvgSides = flow.detrended$dvAvgSidesSel,
                         plotResid  = selectPlots)
  
  # put seasonal averages into a list
  # set embedded df to correspond to GageID
  # append list to overall list 
  tmp.list        <- list(df.flow[,c(1,5,9:length(df.flow))]) 
  names(tmp.list) <- var
  flow.detrended  <- modifyList(flow.detrended, tmp.list)
  
  # calculate mean, sd, & nobs by doy
  df      <- flow.detrended[[var]];   
  df      <- df[,!(names(df) %in% c("date", "q", "LogQ", paste0(var,".gam") ))]
  df.mean <- aggregate(. ~ doy, FUN = mean,        data = df, na.action=na.pass, na.rm=TRUE) 
  df.sd   <- aggregate(. ~ doy, FUN = sd,          data = df, na.action=na.pass, na.rm=TRUE) 
  df.nobs <- aggregate(. ~ doy, FUN = gdata::nobs, data = df, na.action=na.pass, na.rm=TRUE) 
  
  # compute lowess smooth standard deviation (sd)
  if(exists("df.lowess")) rm("df.lowess")
  df.sd.filled <- df.sd
  for (i.day in flow.detrended$dvAvgWinSel) {
    var2  <- paste0("d",i.day)
    # fill in missing sd
    df.sd.filled[, var2] <- fillMissing(df.sd.filled[, var2] )
    # smooth sd
    df2 <- as.data.frame(lowess(x=df.sd.filled[,"doy"], 
                                y=df.sd.filled[, var2] , 
                                f= flow.detrended$lowess.f))
    names(df2) <- c("doy",var2)
    # append i.day'th result
    if(!exists("df.lowess")) {
      df.lowess <- df2 
    } else {
      df.lowess <- merge(df.lowess,df2, by='doy')
    }
  }        
  
  # put mean, sd, nobs, & lowess by doy into a list; 
  # set embedded df to correspond to GageID.sum
  # append list to overall list
  tmp.list        <- list(list(mean = df.mean, sd = df.sd, nobs = df.nobs, lowess.sd = df.lowess))
  names(tmp.list) <- var.sum
  flow.detrended  <- modifyList(flow.detrended, tmp.list)
  
}  

save(flow.detrended, file=outputFileName)

#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# flowStat
for (i.gage in 1:length(flow.detrended$gages$usgsGageID)) {
  
  # set up variable names for raw and summary data
  gage       <- paste0("q",flow.detrended$gages$usgsGageID[i.gage])
  gage.sum   <- paste0("q",flow.detrended$gages$usgsGageID[i.gage],".sum") 
  
  for (dvAvgWinSel in paste0("d",selectPlots) ) {
    .H2(paste0(flow.detrended$gages$usgsGageID[i.gage],"-",
               flow.detrended$gages$siteName[i.gage],
               "  (Avg. Per.: ",dvAvgWinSel,")"))    
    gage.mean      <- flow.detrended[[gage.sum]][["mean"]][[dvAvgWinSel]]
    gage.sd        <- flow.detrended[[gage.sum]][["sd"]][[dvAvgWinSel]]
    gage.doy       <- flow.detrended[[gage.sum]][["sd"]][["doy"]]
    gage.lowess.sd <- flow.detrended[[gage.sum]][["lowess.sd"]][[dvAvgWinSel]]
    gage.nobs      <- flow.detrended[[gage.sum]][["nobs"]][[dvAvgWinSel]]

    par(mfrow = c(3, 1))
    {
      plot(gage.doy, gage.mean , ylim=c(-0.4,0.4)); title(gage)
      plot(gage.doy, gage.sd , ylim=c(0,2), col='grey'); title(gage)
      lines(gage.doy, gage.lowess.sd, col='red',lwd=2)
      plot(gage.doy, gage.nobs , ylim=c(0,60)); title(gage)
            figNum <<- figNum + 1
      title <- paste0( dvAvgWinSel, ": Mean, standard deviation, and number of observations ",
                       " as a Function of Day of Year.")
      .F(title, figNum)
    }
  }
}
```
